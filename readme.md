### Casio框架——RPC远程调用框架



#### Common

公共类和注解

#### Consumer

消费者

#### Provider

提供者

#### Zookeeper

zookeeper连接、节点增删改查以及节点监控的实现

#### Monitor

监控



#### 问题集

##### 1、服务提供者如何有效的将方法注解进zookeeper中？

##### 2、zookeeper连接的心跳如何实现？连接失败需要将服务从zookeeper的对应节点删除

##### 3、RPC的实现？存在连接、粘包、拆包的问题

使用Netty框架实现RPC

##### 4、zookeeper集群实现和生产消费者集群的实现

##### 5、LoaderBalance类的实现，负载均衡

##### 6、dubbo为什么将消费者注册到zk？



### 实现原理

#### 1、最基础版本

通过Netty实现消费者和提供者通信，自定义协议（暂未实现）和传递类，未实现zookeeper注册中心。

服务提供者相对简单，实现channelRead接口，通过反射调用并返回结果。

客户端需要将Service等信息传递给提供者，这里通过Callable和动态代理实现。

客户端实际是将接口的实现类，变成我自定义的实现类，因此需要使用代理，自定义的实现类需要实现：参数生成，通过netty传递数据，获得返回的数据。

存在问题：通讯存在粘包和拆包的问题、自定义协议未实现

#### 2、添加XML解析
服务的注册使用XML，启动时解析XML，并生成文件存储。
后面改成xsd的形式

#### 3、添加zookeeper注册中心
提供者和消费者启动starter，读取配置文件，提供者将需要注册的服务注册进zookeeper中，路径（/appName/serviceName），与dubbo区别，下面少了一层路径（/provider和/consumer），而且不支持多个路径，数据为提供者应用的路径。消费者根据服务生成路径，去提供者获取对应的Netty的IP地址，访问服务提供者，拿到数据

#### 协议格式
```zsh
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+ 
|  BYTE  |        |        |        |        |        |        |         ........         |        | 
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+ 
|  magic | version|  type  |       content length     |            content byte[]                  | 
+--------+--------------------------------------------+--------+--------+--------+--------+--------+
```
> `magic`:固定为 0x27(00011011)   
> `version`:区分协议解析器版本  
> `type`:请求类型  
> `content length`:消息长度  
> `content byte[]`:消息内容

#### 遇到问题
+ 在netty通信传递过程中，我使用了String的加解码器，结果传递了Object对象，导致传递数据无法加解码，一直传递失败。
+ 使用localhost访问Netty正常，使用本地的IP地址，会发现访问拒绝，（提供和消费都需要使用IP？）
+ 框架搭建的有些不合理，（设计模式）



#### 其他

+ Rpc涉及到类在网络上的传输，因此需要注意几点：序列化；不需要传输，但是本地需要用到的属性添加 `transient` 修饰符；类的长度丢失问题，涉及协议
+ 在Rpc中会涉及到需要多线程的问题，因此 `ConcurrentMap` 的使用非常必要，在累加的时候需要使用 `AtomicInteger`。


#### 存在问题

+ 服务注册进zk的路径需要修改，不然多个服务提供者，访问同一个zk，数据会出问题。
+ 服务提供者和消费者很多配置没有分开（要不要分开）